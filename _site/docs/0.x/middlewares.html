<!DOCTYPE html>
<html lang="en">
<head>
    <link href="/assets/bootstrap.min.css" rel="stylesheet" integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
    <link href="/assets/code.css" rel="stylesheet" type="text/css" />
    <link href="/assets/toc.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css">
  <!--  <link rel="apple-touch-icon" sizes="180x180" href="/images/icons/apple-touch-icon-180x180.png"/>
    <link rel="manifest" href="/site.webmanifest"/>
    <meta name="viewport" content="width=device-width"/>
    <meta charSet="utf-8"/>
    <link rel="icon" href="/favicon.svg" type="image/svg+xml"/>--><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Middlewares - CrowPHP an expressive framework for PHP | Web framework for PHP</title>
<meta name="generator" content="Jekyll v3.8.6" />
<meta property="og:title" content="Middlewares - CrowPHP an expressive framework for PHP" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Fast un-opinionated minimalist web framework and server for PHP built on top of battle tested Async PHP servers (SwoolePHP and ReactPHP). CrowPHP lets you build real microservices in PHP without the use of PHP-FPM/Nginx or Apache." />
<meta property="og:description" content="Fast un-opinionated minimalist web framework and server for PHP built on top of battle tested Async PHP servers (SwoolePHP and ReactPHP). CrowPHP lets you build real microservices in PHP without the use of PHP-FPM/Nginx or Apache." />
<link rel="canonical" href="http://localhost:4000/docs/0.x/middlewares" />
<meta property="og:url" content="http://localhost:4000/docs/0.x/middlewares" />
<meta property="og:site_name" content="Web framework for PHP" />
<script type="application/ld+json">
{"@type":"WebPage","url":"http://localhost:4000/docs/0.x/middlewares","headline":"Middlewares - CrowPHP an expressive framework for PHP","description":"Fast un-opinionated minimalist web framework and server for PHP built on top of battle tested Async PHP servers (SwoolePHP and ReactPHP). CrowPHP lets you build real microservices in PHP without the use of PHP-FPM/Nginx or Apache.","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Web framework for PHP" /></head>

<body>
    <div class="container">
        <div class="row">
            <nav class="col-md-3 d-none d-md-block bg-light sidebar">
                <div class="sidebar-sticky">
                  <div class="container" style="margin-top: 20px;">
                    <a class="navbar-brand" href="/">
                        <img src="/assets/crow-logo.svg" alt="" width="200">
                    </a>
                  </div>
                  
                  <ul class="nav flex-column">
    <li class="nav-item">
        <a class="nav-link" href="/docs/0.x">
            Getting Started
        </a>
        <ul class="sub-nav">
            <li class="nav-item">
                <a class="nav-link" href="/docs/0.x#why-crowphp">
                    Why CrowPHP?
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/docs/0.x#your-first-crowphp-microservice">
                    Your First CrowPHP Microservice
                </a>
            </li>
        </ul>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="/docs/0.x/routing">
            Routing
        </a>
        <ul class="sub-nav">
            <li class="nav-item">
                <a class="nav-link" href="/docs/0.x/routing#route-methods">
                    Route methods
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/docs/0.x/routing#route-paths">
                    Route paths
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/docs/0.x/routing#route-parameters">
                    Route parameters
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/docs/0.x/routing#route-groups">
                    Route groups
                </a>
            </li>
        </ul>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="/docs/0.x/middlewares">
            Middlewares
        </a>

        <ul class="sub-nav">
            <li class="nav-item">
                <a class="nav-link" href="/docs/0.x/middlewares#defining-a-middleware">
                    Defining a middleware
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/docs/0.x/middlewares#types-of-middlewares">
                    Types of middlewares
                </a>
            </li>


        </ul>
    </li>
</ul>


                </div>
              </nav>

              <main role="main" class="col-md-9 ml-sm-auto px-4"><div style="position: absolute; inset: 0px; overflow: hidden; pointer-events: none; visibility: hidden; z-index: -1;" class="chartjs-size-monitor"><div class="chartjs-size-monitor-expand" style="position:absolute;left:0;top:0;right:0;bottom:0;overflow:hidden;pointer-events:none;visibility:hidden;z-index:-1;"><div style="position:absolute;width:1000000px;height:1000000px;left:0;top:0"></div></div><div class="chartjs-size-monitor-shrink" style="position:absolute;left:0;top:0;right:0;bottom:0;overflow:hidden;pointer-events:none;visibility:hidden;z-index:-1;"><div style="position:absolute;width:200%;height:200%;left:0; top:0"></div></div></div>
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                  <h1 class="h2">Documentation</h1>
                  <!-- <div class="btn-toolbar mb-2 mb-md-0">
                    <div class="btn-group mr-2">
                      <button type="button" class="btn btn-sm btn-outline-secondary">Share</button>
                      <button type="button" class="btn btn-sm btn-outline-secondary">Export</button>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                      This week
                    </button>
                  </div> -->

                </div>
                <div class="toc_container">
                 <!-- <ul id="toc" class="table-of-contents">
<li class="toc_item toc-h2"><a href="#defining-a-middleware">Defining a middleware</a></li>
<li class="toc_item toc-h2"><a href="#types-of-middlewares">Types of middlewares</a></li>
</ul> -->
                 <ul><li><a href="#defining-a-middleware">Defining a middleware</a></li><li><a href="#types-of-middlewares">Types of middlewares</a></li></ul>

                </div>
                <p>Middleware provide a convenient mechanism for inspecting and filtering HTTP requests entering your application. For example, Laravel includes a middleware that verifies the user of your application is authenticated. If the user is not authenticated, the middleware will redirect the user to your applicationâ€™s login screen. However, if the user is authenticated, the middleware will allow the request to proceed further into the application.</p>

<p>For example, CrowPHP by default uses a routing middleware and an exception handling middleware, CrowPHP follows <code class="language-plaintext highlighter-rouge">PSR-15</code> standard for middlewares so you can also use many readily available middlewares that implement <code class="language-plaintext highlighter-rouge">Psr\Http\Server\MiddlewareInterface</code> and its also very easy to write your custom middleware for example, a logging middleware might log all incoming requests to your application.</p>

<h2 id="defining-a-middleware">Defining a middleware</h2>

<p>To create a new middleware, create a new <code class="language-plaintext highlighter-rouge">PHP</code> file and for this example we will call it <code class="language-plaintext highlighter-rouge">EnsureTokenIsValid.php</code>. We will create a new class <code class="language-plaintext highlighter-rouge">EnsureTokenIsValid</code> that implements</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="kn">namespace</span> <span class="nn">Middlewares</span><span class="p">;</span>

<span class="kn">use</span> <span class="nn">Psr\Http\Message\ResponseInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nn">Psr\Http\Message\ServerRequestInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nn">Psr\Http\Server\MiddlewareInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nn">Psr\Http\Server\RequestHandlerInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nn">RingCentral\Psr7\Response</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">EnsureTokenIsValid</span> <span class="k">implements</span> <span class="nx">MiddlewareInterface</span>
<span class="p">{</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">process</span><span class="p">(</span>
        <span class="nx">ServerRequestInterface</span> <span class="nv">$request</span><span class="p">,</span> 
        <span class="nx">RequestHandlerInterface</span> <span class="nv">$handler</span><span class="p">)</span><span class="o">:</span> <span class="nx">ResponseInterface</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="na">getHeader</span><span class="p">(</span><span class="s1">'token'</span><span class="p">)</span> <span class="o">!==</span> <span class="s1">'my-secret-token'</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nx">Response</span><span class="p">(</span><span class="mi">403</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$handler</span><span class="o">-&gt;</span><span class="na">handle</span><span class="p">(</span><span class="nv">$request</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now we can apply our new middleware to any route by simply calling <code class="language-plaintext highlighter-rouge">middleware</code> method after the route.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nv">$router</span><span class="o">-&gt;</span><span class="na">post</span><span class="p">(</span><span class="s1">'/posts'</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nx">RequestInterface</span> <span class="nv">$request</span><span class="p">,</span> <span class="nx">ResponseInterface</span> <span class="nv">$response</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$response</span><span class="o">-&gt;</span><span class="na">getBody</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">write</span><span class="p">(</span><span class="s1">'valid token'</span><span class="p">);</span>
    <span class="k">return</span> <span class="nv">$response</span><span class="p">;</span>
<span class="p">})</span><span class="o">-&gt;</span><span class="na">middleware</span><span class="p">(</span><span class="k">new</span> <span class="nx">EnsureTokenIsValid</span><span class="p">());</span>

</code></pre></div></div>
<p>In the example above we are applying the middleware that is following <code class="language-plaintext highlighter-rouge">PSR-15</code> standards you can also pass <code class="language-plaintext highlighter-rouge">callables</code> instead.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$router</span><span class="o">-&gt;</span><span class="na">post</span><span class="p">(</span><span class="s1">'/post'</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nx">RequestInterface</span> <span class="nv">$request</span><span class="p">,</span> <span class="nx">ResponseInterface</span> <span class="nv">$response</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$response</span><span class="o">-&gt;</span><span class="na">getBody</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">write</span><span class="p">(</span><span class="s1">'My Post'</span><span class="p">);</span>
    <span class="k">return</span> <span class="nv">$response</span><span class="p">;</span>
<span class="p">})</span><span class="o">-&gt;</span><span class="na">middleware</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nx">RequestInterface</span> <span class="nv">$request</span><span class="p">,</span> <span class="nx">RequestHandlerInterface</span> <span class="nv">$next</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s2">"Logging here in the /post request</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
    <span class="k">return</span> <span class="nv">$next</span><span class="o">-&gt;</span><span class="na">handle</span><span class="p">(</span><span class="nv">$request</span><span class="p">);</span>
<span class="p">}));</span>

</code></pre></div></div>

<h2 id="types-of-middlewares">Types of middlewares</h2>

<p>CrowPHP has different types of middlewares and its important to understand them since they can be used for different purposes.</p>

<ul>
  <li>Global Middlewares</li>
  <li>Group-level Middlewares</li>
  <li>Route-level Middlewares</li>
</ul>

<p>In the examples above we have learned about the <code class="language-plaintext highlighter-rouge">Route-level</code> middlewares, what if you want to apply the same middleware to multiple routes and thatâ€™s where <code class="language-plaintext highlighter-rouge">Group-level</code> middlewares comes in to the rescue.</p>

<p>We can create a route group and after the first two <code class="language-plaintext highlighter-rouge">required</code> arguments we can pass an <code class="language-plaintext highlighter-rouge">n</code> number of arguments on <code class="language-plaintext highlighter-rouge">route-group</code> for middlewares which can be again a <code class="language-plaintext highlighter-rouge">PSR-15</code> standard middleware or a <code class="language-plaintext highlighter-rouge">callable</code>. All of the middlewares passed will be executed in the sequence that they are passed to the <code class="language-plaintext highlighter-rouge">route-group</code> before finally passing the request to the request handler function of each route inside the group and ofcourse it can be nested with more middlewares passed to the sub routes or sub-groups with in.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nv">$router</span><span class="o">-&gt;</span><span class="na">addGroup</span><span class="p">(</span><span class="s1">'/admin'</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nx">RouterInterface</span> <span class="nv">$router</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$router</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'/posts/id/{id}'</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span>
        <span class="nx">RequestInterface</span> <span class="nv">$request</span><span class="p">,</span> 
        <span class="nx">ResponseInterface</span> <span class="nv">$response</span><span class="p">,</span> <span class="nv">$id</span><span class="p">)</span><span class="o">:</span> <span class="nx">ResponseInterface</span> <span class="p">{</span>

        <span class="nv">$response</span><span class="o">-&gt;</span><span class="na">getBody</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">write</span><span class="p">(</span><span class="nb">json_encode</span><span class="p">([</span><span class="s2">"post_id"</span> <span class="o">=&gt;</span> <span class="nv">$id</span><span class="p">]));</span>
        <span class="k">return</span> <span class="nv">$response</span><span class="o">-&gt;</span><span class="na">withHeader</span><span class="p">(</span><span class="s1">'Content-Type'</span><span class="p">,</span> <span class="s1">'application/json'</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">withStatus</span><span class="p">(</span><span class="mi">403</span><span class="p">);</span>
    <span class="p">})</span><span class="o">-&gt;</span><span class="na">middleware</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nx">RequestInterface</span> <span class="nv">$request</span><span class="p">,</span> <span class="nx">RequestHandlerInterface</span> <span class="nv">$next</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">echo</span> <span class="s2">"This is a local middleware 1 for sunny</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
        <span class="k">return</span> <span class="nv">$next</span><span class="o">-&gt;</span><span class="na">handle</span><span class="p">(</span><span class="nv">$request</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nv">$router</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'/comments/id/{id}'</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span>
        <span class="nx">RequestInterface</span> <span class="nv">$request</span><span class="p">,</span> 
        <span class="nx">ResponseInterface</span> <span class="nv">$response</span><span class="p">,</span> <span class="nv">$id</span><span class="p">)</span><span class="o">:</span> <span class="nx">ResponseInterface</span> <span class="p">{</span>
        <span class="nv">$response</span><span class="o">-&gt;</span><span class="na">getBody</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">write</span><span class="p">(</span><span class="s1">'comments '</span> <span class="o">.</span> <span class="nv">$id</span><span class="p">);</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s1">'Hey i am an exception'</span><span class="p">);</span>
    <span class="p">});</span>

<span class="p">},</span> <span class="k">function</span> <span class="p">(</span><span class="nx">RequestInterface</span> <span class="nv">$request</span><span class="p">,</span> <span class="nx">RequestHandlerInterface</span> <span class="nv">$next</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s2">"This is a group middleware 1</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
    <span class="k">return</span> <span class="nv">$next</span><span class="o">-&gt;</span><span class="na">handle</span><span class="p">(</span><span class="nv">$request</span><span class="p">);</span>
<span class="p">},</span> <span class="k">function</span> <span class="p">(</span><span class="nx">RequestInterface</span> <span class="nv">$request</span><span class="p">,</span> <span class="nx">RequestHandlerInterface</span> <span class="nv">$next</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s2">"This is a group middleware 2</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
    <span class="k">return</span> <span class="nv">$next</span><span class="o">-&gt;</span><span class="na">handle</span><span class="p">(</span><span class="nv">$request</span><span class="p">);</span>
<span class="p">});</span>

</code></pre></div></div>

<p>Last but not the least are the <code class="language-plaintext highlighter-rouge">global</code> middlewares and as the name suggests these middlewares are applied to all the requests that enter the server.
To define the <code class="language-plaintext highlighter-rouge">global</code> middleware we use the <code class="language-plaintext highlighter-rouge">use</code> method on the <code class="language-plaintext highlighter-rouge">app</code> instance of <code class="language-plaintext highlighter-rouge">CrowServer</code>.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$app</span><span class="o">-&gt;</span><span class="na">use</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nx">RequestInterface</span> <span class="nv">$request</span><span class="p">,</span> <span class="nx">RequestHandlerInterface</span> <span class="nv">$next</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s2">"This is a global middleware 1</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
    <span class="k">return</span> <span class="nv">$next</span><span class="o">-&gt;</span><span class="na">handle</span><span class="p">(</span><span class="nv">$request</span><span class="p">);</span>
<span class="p">});</span>

<span class="nv">$app</span><span class="o">-&gt;</span><span class="na">use</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nx">RequestInterface</span> <span class="nv">$request</span><span class="p">,</span> <span class="nx">RequestHandlerInterface</span> <span class="nv">$next</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s2">"This is a global middleware 2</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
    <span class="k">return</span> <span class="nv">$next</span><span class="o">-&gt;</span><span class="na">handle</span><span class="p">(</span><span class="nv">$request</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<p>Like other middlewares you can pass <code class="language-plaintext highlighter-rouge">PSR-15</code> compliant middlewares or <code class="language-plaintext highlighter-rouge">callables</code> to the <code class="language-plaintext highlighter-rouge">use</code> method and the execution will be in the sequence in which they are passed.</p>


                </div>

              </main>
        </div>

    </div>

<footer>
    <!-- Grid container -->
    <div class="container text-center p-4">
        <!--Grid row-->
        <div class="row">
            <div class="col">
                <nav class="navbar navbar-expand-lg navbar-light">

                    <div class="collapse navbar-collapse">
                        <ul class="navbar-nav mx-auto">
                            <li class="nav-item"><a class="nav-link" href="/">Home </a></li>
                            <li class="nav-item"><a class="nav-link" href="/#installation"> Installation </a></li>
                            <li class="nav-item"><a class="nav-link" href="#"> Documentation </a></li>
                        </ul>
                    </div>
                </nav>
            </div>
        </div>
        <div class="row">
            <div class="col text-center">
                <img src="https://github.com/crowphp/crow/workflows/build/badge.svg">
                <img src="https://img.shields.io/github/license/crowphp/crow">
                <img src="https://img.shields.io/endpoint?url=https://badger.crowphp.com/coverage/master">
            </div>
        </div>
        <!--Grid row-->
    </div>
    <!-- Grid container -->

    <!-- Copyright -->
    <div class="text-center pb-5">
        Â© 2021 Copyright crowphp.com
    </div>
    <!-- Copyright -->
</footer>


</body>
</html>
